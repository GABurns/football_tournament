<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cliftonville 2019s Tournament</title>
  <style>
    :root { --red:#D71920; --red-700:#b51218; --green:#1F8F4E; --white:#fff; --surface:#111317; --card:#161a20; --border:#2a323c; --shadow:0 10px 24px rgba(0,0,0,.35); --radius:16px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--surface);color:var(--white)}
    .topbar{background:linear-gradient(90deg,var(--red) 0%,var(--red-700) 55%,var(--white) 100%);padding:22px 16px;box-shadow:var(--shadow)}
    .brand{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:14px;justify-content:center}
    .badge{width:36px;height:36px;border-radius:50%;background:var(--white);display:grid;place-items:center;color:var(--red);font-weight:900}
    .brand h1{margin:0;font-size:clamp(22px,3vw,32px);letter-spacing:.3px;text-align:center}
    nav{background:#0d0f12;border-bottom:1px solid var(--border)}
    .navwrap{max-width:1200px;margin:0 auto;display:flex;gap:8px;padding:10px 12px;justify-content:center}
    .tab{appearance:none;border:1px solid var(--border);background:#13161b;color:#cfd7df;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:600}
    .tab[aria-current="page"]{background:var(--red);border-color:var(--red-700);color:var(--white);box-shadow:0 0 0 2px rgba(215,25,32,.25)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0;font-size:18px;letter-spacing:.2px}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:#141820}
    .card .content{padding:12px 14px 16px}
    /* Center Fixtures page only */
    #fixtures .content,#fixtures-list,#fixtures .muted{text-align:center}
    #fixtures .fixture{justify-content:center;text-align:center}
    #fixtures .fixture .team,#fixtures .fixture .when{text-align:center}
    /* Shared UI */
    .fixture{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;padding:10px 8px;border-bottom:1px dashed var(--border)}
    .fixture .when{grid-column:span 3;font-size:12px;color:#c6ccd7;margin-top:2px}
    .score{font-variant-numeric:tabular-nums;font-weight:800}
    .groups{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media (min-width:900px){.groups{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .bracket-wrap{overflow-x:auto;padding:8px}
    svg.bracket{width:100%;height:auto;max-height:460px;display:block}
    .box{fill:rgba(215,25,32,.12);stroke:var(--red-700)}
    .label{font-size:12px;fill:#c6ccd7}
    .teamText{font-size:14px;fill:var(--white);font-weight:700}
    .scoreText{font-size:14px;fill:var(--white);font-variant-numeric:tabular-nums;font-weight:800}
    .connector{stroke:var(--green);stroke-width:3;fill:none}
    .page{display:none}.page.active{display:block}

    /* ===== Tables (zebra stripes) ===== */
    #groups table{width:100%;border-collapse:collapse}
    #groups th,#groups td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right}
    #groups th.col-team,#groups td.col-team{text-align:left}
    #groups thead th{font-size:12px;color:#cfd7df;text-transform:uppercase;letter-spacing:.04em}
    #groups tbody tr:nth-child(odd){background:rgba(255,255,255,.03)}
    #groups tbody tr:nth-child(even){background:rgba(255,255,255,.06)}
    #groups tbody tr:hover{background:rgba(215,25,32,.10)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><div class="badge">C</div><div><h1>Cliftonville 2019s Tournament</h1></div></div>
  </div>
  <nav>
    <div class="navwrap">
      <button class="tab" data-route="#fixtures" aria-current="page">Fixtures & Results</button>
      <button class="tab" data-route="#groups">Group Phase</button>
      <button class="tab" data-route="#knockout">Knockout Phase</button>
    </div>
  </nav>

  <main class="container">
    <!-- Fixtures Page -->
    <section class="page active" id="fixtures">
      <section class="card">
        <div class="head"><h2>Fixtures & Results</h2></div>
        <div class="content">
          <!-- Group Filter (added) -->
          <div id="fixtures-filter" style="margin-bottom:1em;"></div>
          <div id="fixtures-list"></div>
        </div>
      </section>
    </section>

    <!-- Groups Page -->
    <section class="page" id="groups">
      <section class="card" id="groups-card">
        <div class="head"><h2>Group Tables</h2><span class="muted" id="last-updated">Updated just now</span></div>
        <div class="content"><div class="groups" id="groups-root"></div></div>
      </section>
    </section>

    <!-- Knockout Page -->
    <section class="page" id="knockout">
      <section class="card" id="bracket-card">
        <div class="head"><h2>Knockout Bracket</h2><span class="muted">Semi-finals → Final</span></div>
        <div class="content"><div class="bracket-wrap"><svg class="bracket" id="bracket" viewBox="0 0 900 380" preserveAspectRatio="xMidYMid meet"></svg></div></div>
      </section>
    </section>
  </main>

  <script>
    // ===== Remote data =====
    const DATA_URL = 'https://raw.githubusercontent.com/GABurns/football_tournament/main/tournament.json';
    let groups = [], teams = [], matches = []; let teamMap = new Map();

    async function loadData(){
      const url = DATA_URL + (DATA_URL.includes('?') ? '&' : '?') + 'v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load data: ' + res.status);
      const data = await res.json();
      groups = data.groups || []; teams = data.teams || []; matches = data.matches || [];
      teamMap = new Map(teams.map(t => [t.id, t]));
    }

    // ===== Routing =====
    function setActiveRoute(hash){
      const target = hash || '#fixtures';
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const pg = document.querySelector(target); if (pg) pg.classList.add('active');
      document.querySelectorAll('.navwrap .tab').forEach(b=>b.removeAttribute('aria-current'));
      const nav = Array.from(document.querySelectorAll('.navwrap .tab')).find(b=>b.dataset.route===target);
      if (nav) nav.setAttribute('aria-current','page');
      if (target === '#fixtures') renderFixtures();
      if (target === '#groups') renderGroupTables();
      if (target === '#knockout') renderBracket();
    }
    window.addEventListener('hashchange', ()=>setActiveRoute(location.hash));
    document.querySelectorAll('.navwrap .tab').forEach(btn=>btn.addEventListener('click',()=>{ location.hash = btn.dataset.route; }));

    // ===== Helpers =====
    const fmtDate = iso => new Date(iso).toLocaleString();
    function computeStandingsForGroup(groupId){
      const tms = teams.filter(t=>t.groupId===groupId);
      const table = new Map(tms.map(t=>[t.id,{ teamId:t.id, teamName:t.name, played:0, won:0, drawn:0, lost:0, gf:0, ga:0, gd:0, pts:0 }]));
      const played = matches.filter(m=>m.stage==='group' && m.groupId===groupId && m.status==='played');
      for (const m of played){
        const h=table.get(m.homeId), a=table.get(m.awayId); if(!h||!a) continue;
        const hg=+m.homeGoals, ag=+m.awayGoals;
        h.played++; a.played++; h.gf+=hg; h.ga+=ag; a.gf+=ag; a.ga+=hg; h.gd=h.gf-h.ga; a.gd=a.gf-a.ga;
        if (hg>ag){h.won++;a.lost++;h.pts+=3;} else if (hg<ag){a.won++;h.lost++;a.pts+=3;} else {h.drawn++;a.drawn++;h.pts++;a.pts++;}
      }
      return Array.from(table.values()).sort((x,y)=> y.pts-x.pts || y.gd-x.gd || y.gf-x.gf || x.teamName.localeCompare(y.teamName));
    }
    const groupWinner = gid => { const r = computeStandingsForGroup(gid); return r.length && r[0].played>=3 ? r[0].teamId : null; };
    const getWinnerFromMatch = (m, homeId, awayId) => { if (!m || m.status!=='played') return null; if (m.homeGoals>m.awayGoals) return homeId; if (m.homeGoals<m.awayGoals) return awayId; return null;}
    function resolvePlaceholder(id){
      if (!id || !id.startsWith('WIN-')) return id;
      const key = id.split('-')[1];
      if (['A','B','C','D'].includes(key)) return groupWinner(key) || id;
      if (key==='SF1'){ const sf1 = matches.find(m=>m.ko==='SF1'); return getWinnerFromMatch(sf1, resolvePlaceholder(sf1?.homeId), resolvePlaceholder(sf1?.awayId)) || id; }
      if (key==='SF2'){ const sf2 = matches.find(m=>m.ko==='SF2'); return getWinnerFromMatch(sf2, resolvePlaceholder(sf2?.homeId), resolvePlaceholder(sf2?.awayId)) || id; }
      return id;
    }
    const labelForTeam = id => (teamMap.get(resolvePlaceholder(id))?.name) || (id?.startsWith('WIN-') ? id.replace('WIN-','Winner ') : (id||''));

    // ===== Fixtures Filter (REVISED) =====
    function renderFixturesFilter() {
      const filterRoot = document.getElementById('fixtures-filter');
      if (!filterRoot) return;
      filterRoot.innerHTML = `
        <label for="group-filter" style="font-weight:600;margin-right:6px;">Filter by group:</label>
        <select id="group-filter">
          <option value="">All Groups</option>
          ${groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
        </select>
      `;
      const select = filterRoot.querySelector('#group-filter');
      select.addEventListener('change', renderFixtures); // Re-render fixtures on change
    }

    // ===== Fixtures (REVISED) =====
    function renderFixtures(){
      // DO NOT call renderFixturesFilter() here!
      const root = document.getElementById('fixtures-list'); if (!root) return; root.innerHTML='';
      const selectedGroup = document.getElementById('group-filter')?.value || '';
      let list = [...matches];
      if (selectedGroup) {
        list = list.filter(m => m.stage === 'group' && m.groupId === selectedGroup);
      }
      list.sort((a,b)=> new Date(a.date)-new Date(b.date));
      if (!list.length){ root.innerHTML = '<p class="muted">No fixtures found for this group.</p>'; return; }
      for (const m of list){
        const div = document.createElement('div'); div.className='fixture';
        div.innerHTML = `
          <div class="team"><span class="name">${labelForTeam(m.homeId)}</span></div>
          <div>${m.status==='played'?`<span class='score'>${m.homeGoals} – ${m.awayGoals}</span>`:'vs'}</div>
          <div class="team" style="justify-content:flex-end"><span class="name">${labelForTeam(m.awayId)}</span></div>
          <div class="when">${m.stage==='group' ? `Group ${m.groupId}${m.round?` · R${m.round}`:''}` : (m.ko||'')} · ${fmtDate(m.date)} · <span class="${m.status==='played'?'success':'muted'}">${m.status==='played'? 'Played':'Upcoming'}</span></div>
        `;
        root.appendChild(div);
      }
    }

    // ===== Groups =====
    function renderGroupTables(){
      const root = document.getElementById('groups-root'); if (!root) return; root.innerHTML='';
      if (!groups.length){ root.innerHTML = '<p class="muted">No groups configured.</p>'; return; }
      for (const g of groups){
        const rows = computeStandingsForGroup(g.id);
        const sec = document.createElement('section'); sec.className='card';
        sec.innerHTML = `
          <div class="head"><h2>${g.name}</h2></div>
          <div class="content">
            <table>
              <thead><tr><th class='col-team'>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead>
              <tbody>${rows.map(r=>`<tr><td class='col-team'>${r.teamName}</td><td>${r.played}</td><td>${r.won}</td><td>${r.drawn}</td><td>${r.lost}</td><td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td>${r.pts}</td></tr>`).join('')}</tbody>
            </table>
          </div>`;
        root.appendChild(sec);
      }
      const lu=document.getElementById('last-updated'); if (lu) lu.textContent='Updated '+new Date().toLocaleString();
    }

    // ===== Bracket =====
    function renderBracket(){
      const svg = document.getElementById('bracket'); if (!svg) return; svg.innerHTML='';
      const SF1 = matches.find(m=>m.ko==='SF1');
      const SF2 = matches.find(m=>m.ko==='SF2');
      const FINAL = matches.find(m=>m.ko==='FINAL');
      if (!SF1 || !SF2 || !FINAL){ svg.innerHTML='<text x="20" y="30" class="label">No knockout matches found.</text>'; return; }
      const NS='http://www.w3.org/2000/svg';
      const make=(n,a={})=>{ const el=document.createElementNS(NS,n); for(const[k,v]of Object.entries(a)) el.setAttribute(k,v); return el; };
      const add=n=>svg.appendChild(n);
      const teamLine=(x,y,label,score)=>{ const g=make('g'); g.appendChild(make('rect',{x,y,rx:12,ry:12,width:320,height:48,class:'box'})); const t=make('text',{x:x+16,y:y+30,class:'teamText'}); t.textContent=label; g.appendChild(t); if(score!==undefined&&score!==''){ const s=make('text',{x:x+265,y:y+30,class:'scoreText'}); s.textContent=score; g.appendChild(s); } return g; };
      const title=(x,y,txt)=>{ const t=make('text',{x,y,class:'label'}); t.textContent=txt; add(t); };
      const block=(x,y,titleText,hId,aId,hg,ag)=>{ title(x,y-10,titleText); add(teamLine(x,y,labelForTeam(hId),hg??'')); add(teamLine(x,y+56,labelForTeam(aId),ag??'')); return {cx:x+320, cyTop:y+24, cyBot:y+80};};
      const sf1=block(40,70,'Semi-final 1 (A vs B)', resolvePlaceholder(SF1.homeId), resolvePlaceholder(SF1.awayId), SF1.homeGoals, SF1.awayGoals);
      const sf2=block(40,250,'Semi-final 2 (C vs D)', resolvePlaceholder(SF2.homeId), resolvePlaceholder(SF2.awayId), SF2.homeGoals, SF2.awayGoals);
      const midY=(sf1.cyBot+sf2.cyTop)/2; add(make('path',{d:`M ${sf1.cx} ${sf1.cyTop} H 500 V ${midY} H 610`,class:'connector'})); add(make('path',{d:`M ${sf2.cx} ${sf2.cyBot} H 500 V ${midY} H 610`,class:'connector'}));
      block(640,160,'Final', resolvePlaceholder(FINAL.homeId), resolvePlaceholder(FINAL.awayId), FINAL.homeGoals, FINAL.awayGoals);
    }

    // ===== Init =====
    (async function(){
      try { await loadData(); } catch(e) { console.error(e); }
      renderFixturesFilter(); // Ensure filter is rendered once after data loads
      setActiveRoute(location.hash || '#fixtures');
    })();
  </script>
</body>
</html>
